<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat</title>
    <style>
        body { font-family: sans-serif; background-color: #121212; color: white; display: flex; justify-content: center; height: 100vh; margin: 0; }
        .container { width: 400px; display: flex; flex-direction: column; height: 95vh; border: 1px solid #333; border-radius: 10px; overflow: hidden; background: #1e1e1e; }
        
        /* Login Screen */
        #login-screen { padding: 20px; display: flex; flex-direction: column; gap: 10px; justify-content: center; height: 100%; }
        input { padding: 10px; background: #333; border: none; color: white; border-radius: 5px; }
        button { padding: 10px; background: #007bff; border: none; color: white; cursor: pointer; border-radius: 5px; font-weight: bold; }
        button:hover { background: #0056b3; }

        /* Chat Screen */
        #chat-screen { display: none; flex-direction: column; height: 100%; }
        .header { padding: 15px; background: #2d2d2d; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; }
        .chat-box { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Message Bubbles */
        .msg { max-width: 70%; padding: 8px 12px; border-radius: 15px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background-color: #007bff; color: white; border-bottom-right-radius: 2px; }
        .msg.friend { align-self: flex-start; background-color: #333; color: #ddd; border-bottom-left-radius: 2px; }
        .sender-name { font-size: 10px; opacity: 0.6; margin-bottom: 2px; display: block; }

        .input-area { padding: 10px; background: #2d2d2d; display: flex; gap: 10px; }
        .input-area input { flex: 1; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="login-screen">
        <h2 style="text-align: center;">ðŸ”’ Secure Login</h2>
        <input id="username" placeholder="Username">
        <input id="password" type="password" placeholder="Password">
        <button onclick="login()">Enter System</button>
    </div>

    <div id="chat-screen">
        <div class="header">
            <span id="chat-title">Not Connected</span>
            <input id="friend-input" placeholder="Friend's Username" style="width: 120px; padding: 5px;">
            <button onclick="connect()" style="padding: 5px 10px; font-size: 12px;">Connect</button>
        </div>

        <div id="chat-box" class="chat-box"></div>

        <div class="input-area">
            <input id="msg-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
            <button onclick="send()">Send</button>
        </div>
    </div>

</div>

<script>
    let token = null;
    let currentUser = null;
    let ws = null;

    async function login() {
        const userField = document.getElementById("username").value;
        const passField = document.getElementById("password").value;

        try {
            let res = await fetch("/login", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ username: userField, password: passField })
            });

            const data = await res.json();
            
            if (!res.ok) {
                alert(data.detail || "Login failed");
                return;
            }

            token = data.access_token;
            currentUser = userField;
            
            // Switch Screens
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("chat-screen").style.display = "flex";
            console.log("Logged in as:", currentUser);

        } catch (err) {
            console.error(err);
            alert("Server error");
        }
    }

    function connect() {
        if (!token) return;
        
        const friend = document.getElementById("friend-input").value;
        if(!friend) return alert("Enter friend name");

        // Close existing connection if any
        if (ws) ws.close();

        ws = new WebSocket(`ws://${window.location.host}/ws?token=${token}`);

        ws.onopen = () => {
            console.log("WS Connected");
            document.getElementById("chat-box").innerHTML = ""; // Clear old chat
            document.getElementById("chat-title").innerText = `Chatting with ${friend}`;
            
            ws.send(JSON.stringify({
                type: "join",
                room: friend
            }));
        };

        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);

            if (data.type === "chat") {
                addMessage(data.sender, data.text);
            } else if (data.type === "system") {
                addSystemMessage(data.message);
            } else if (data.type === "error") {
                alert(data.message);
            }
        };
    }

    function send() {
        const input = document.getElementById("msg-input");
        const text = input.value;
        const friend = document.getElementById("friend-input").value;

        if (!ws || !text) return;

        ws.send(JSON.stringify({
            type: "chat",
            room: friend,
            text: text
        }));

        input.value = "";
    }

    function addMessage(sender, text) {
        const box = document.getElementById("chat-box");
        const isMe = sender === currentUser;
        
        const msgDiv = document.createElement("div");
        msgDiv.className = `msg ${isMe ? "me" : "friend"}`;
        msgDiv.innerHTML = `<span class="sender-name">${sender}</span>${text}`;
        
        box.appendChild(msgDiv);
        box.scrollTop = box.scrollHeight; // Auto-scroll to bottom
    }

    function addSystemMessage(text) {
        const box = document.getElementById("chat-box");
        const div = document.createElement("div");
        div.style.textAlign = "center";
        div.style.fontSize = "12px";
        div.style.color = "#888";
        div.style.margin = "10px 0";
        div.innerText = text;
        box.appendChild(div);
    }

    function handleEnter(e) {
        if (e.key === "Enter") send();
    }
</script>

</body>
</html>